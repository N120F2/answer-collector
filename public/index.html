<!DOCTYPE html>
<html>

<head>
    <title> Answer collector </title>
    <link rel="stylesheet" href="styles.css">
    <meta name="viewport" content="width=device-width, initial-scale=0.45" />
    <script>
        'use strict'
        async function getContributors() {
            let outResult = undefined;
            try {
                const response = await fetch('https://' + location.hostname + '/contributors', {
                    method: 'GET',
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/json;charset=utf-8'
                    },
                });
                if (!response.ok) {
                    throw new Error("HTTP status " + response.status);
                }
                const result = await response.text();
                outResult = JSON.parse(result);
            } catch (e) {
                console.error(e);
            }
            return outResult;
        }
        async function getContributorsNames() {
            return new Promise(
                async (resolve, reject) => {
                    try {
                        const response = await fetch('https://' + location.hostname + '/contributorsNames.json', {
                            method: 'GET',
                            credentials: 'same-origin',
                            headers: {
                                'Content-Type': 'application/json;charset=utf-8'
                            }
                        });
                        if (!response.ok) {
                            throw new Error("HTTP status " + response.status);
                        }
                        const result = await response.text();
                        let arrayNames = JSON.parse(result);
                        resolve(arrayNames);
                    } catch (e) {
                        reject(e);
                    }
                });
        }
        document.addEventListener('DOMContentLoaded', function () {
            let stroragedLogin = localStorage.getItem('login');
            if (stroragedLogin !== null) document.getElementById("nameInput").value = stroragedLogin;
            getContributors()
                .then((contributors) => {
                    loadContrTable(contributors);
                    console.log('Contributors loaded');
                })
                .catch(() => {
                    console.log("Contributors table loading failed");
                });
            getContributorsNames()
                .then((arrayNames) => {
                    setConributorsNames(arrayNames);
                    let stroragedLogin = localStorage.getItem('login');
                    if (arrayNames.indexOf(stroragedLogin)>-1) {                       
                        if (stroragedLogin !== null) document.getElementById("nameInput").value = stroragedLogin;
                    }
                    console.log(arrayNames);
                    document.getElementById("page-container").style.display = "block";
                    console.log('Contributors names loaded');
                })
                .catch((e) => {
                    console.log("Contributors names loading failed");
                    let errorMsg = document.createElement('div');
                    errorMsg.innerHTML = "<span style='color:red; font-size: 130%;'>" + e + ". Contributors names loading failed"
                    document.getElementById("page-container").before(errorMsg);
                });

        });
        async function add(name, question, answer) {
            return new Promise(
                async (resolve, reject) => {
                    try {
                        const response = await fetch('https://' + location.hostname + '/add', {
                            method: 'POST',
                            credentials: 'same-origin',
                            headers: {
                                'Content-Type': 'application/json;charset=utf-8'
                            },
                            body: JSON.stringify({
                                login: name,
                                question: question,
                                answer: answer
                            })
                        });
                        if (!response.ok) {
                            throw new Error("HTTP status " + response.status);
                        }
                        const result = await response.text();
                        resolve(result);
                    } catch (e) {
                        reject("error");
                    }
                });
        }
        async function uploadData() {
            console.log(document.getElementById("nameInput").selectedOptions[0].value);
            if (document.getElementById("nameInput").selectedOptions[0].value == 'deny') {
                document.getElementById("infoLabel").innerText = 'Pick your name!!!';
                document.getElementById('infoLabel').style.color = 'red';
                document.getElementById('infoLabel').style.display = 'block';
                document.getElementById('enterButton').style.display = 'none';
                setTimeout(() => {
                    document.getElementById('infoLabel').style.display = 'none';
                    document.getElementById('enterButton').style.display = 'block';
                }, 2000)
                return;
            }
            let name = document.getElementById("nameInput").selectedOptions[0].value;
            let question = document.getElementById('question').value;
            let answer = document.getElementById('answer').value;
            //document.getElementById("nameInput").value = '';
            document.getElementById('question').value = '';
            document.getElementById('answer').value = '';
            if (localStorage.getItem('login') != name) localStorage.setItem('login', name);
            let result = null;
            try {
                result = await add(name, question, answer);
            }
            catch (e) {
                console.log(e);
            }
            console.log(result);
            switch (result) {
                case "added":
                    document.getElementById("infoLabel").innerText = 'Answer successfully added';
                    document.getElementById('infoLabel').style.color = 'black';
                    break;
                case "no_added":
                    document.getElementById("infoLabel").innerText = 'Answer already added.';
                    document.getElementById('infoLabel').style.color = 'black';
                    break;
                default:
                    document.getElementById("infoLabel").innerText = 'Some error! Try again.';
                    document.getElementById('infoLabel').style.color = 'red';
                    break;
            }
            document.getElementById('infoLabel').style.display = 'block';
            document.getElementById('enterButton').style.display = 'none';
            setTimeout(() => {
                document.getElementById('infoLabel').style.display = 'none';
                document.getElementById('enterButton').style.display = 'block';

            }, 2000)
        }
        function loadContrTable(contributorsObj) {
            const contributorsMap = new Map(Object.entries(contributorsObj));
            const contributorsMapSorted = new Map([...contributorsMap.entries()].sort((a, b) => b[1] - a[1]));
            if (contributorsMapSorted.size == 0) return;
            var container = document.getElementById('contributorsContainer');
            var tbl = document.createElement('table');
            tbl.style.display = 'inline-block';//inline-block
            tbl.setAttribute('id', 'contribTable');
            var tbdy = document.createElement('tbody');
            var th = document.createElement('tr');
            tbdy.appendChild(th);
            th.innerHTML = "<th>Name</th><th>Answers</th>";
            let answersCount = 0;
            for (let entry of contributorsMapSorted) {
                var tr = document.createElement('tr');
                for (var j = 0; j < 2; j++) {
                    var td = document.createElement('td');
                    if (j == 0) {
                        td.innerText = entry[0];
                    }
                    else {
                        td.innerText = entry[1];
                        answersCount += +entry[1];
                    }
                    tr.appendChild(td);
                }
                tbdy.appendChild(tr);
            }
            tbl.appendChild(tbdy);
            container.appendChild(tbl);
            //counter
            let counter = document.createElement('div');
            counter.style.fontWeight = 'bold';
            counter.style.fontSize = '110%';
            counter.innerText = "Number of collected answers: " + answersCount;
            tbl.after(counter);
        }
        function setConributorsNames(names) {
            document.getElementById('nameInput').innerHTML = "";
            //console.log(document.getElementById('nameInput').getElementsByTagName('option'));
            let selectInput = document.getElementById("nameInput");

            let optionHead = document.createElement('option');
            optionHead.innerText = "Your name";
            optionHead.value = "deny";
            optionHead.selected = true;
            optionHead.disabled = true;
            selectInput.appendChild(optionHead);
            //adding contibutors
            for (let i = 0; i < names.length; i++) {
                let option = document.createElement('option');
                option.innerText = names[i];
                option.value = names[i];
                selectInput.appendChild(option);
            }

        }

    </script>


</head>

<body>
    <div id="page-container" style="display: none;">

        <div id="content-wrap">
            <header id="headTitle">
                <h1 id='welcomeTitle'>Answer Collector</h1>
            </header>
            <table style="width: 100%;">
                <tr>
                    <td style="width: 300px;">
                        <span style="font-weight: bold;font-size: 130%">Top contributors</span>
                        <div id='contributorsContainer'> </div>
                    </td>
                    <td>
                        <form id='enterForm' action='javascript: document.getElementById("enterButton").click();'>
                            <label id="inputLabel1" style="font-weight: bold;">Please enter your name:</label></br>
                            <!--<input type="text" id="nameInput" placeholder="Your name.."></br>-->
                            <select size="1" id="nameInput" required form="enterForm">
                                <option value='deny' selected disabled>Your name</option>
                                <option value="Piko">Piko</option>
                                <option value="Vlad">Vlad</option>
                                <option value="Anya">Anya</option>
                                <option value="Dima">Dima</option>
                            </select></br>

                            <label id="inputLabel2" style="font-weight: bold;">Please enter a question:</label></br>
                            <textarea id="question" placeholder="Past question here" rows="4" cols="50"></textarea></br>

                            <label id="inputLabel3" style="font-weight: bold;">Please enter a correct
                                answer:</label></br>
                            <textarea id="answer" placeholder="Past answer here" rows="4" cols="50"></textarea></br>

                            <label id="infoLabel" style="font-weight: bold; color:red; display:none"></label>

                            <button type="button" class="form_button" id="enterButton"
                                onclick='uploadData();'>Enter</button>
                        </form>
                        <div id="downloadLinks">
                            <button onclick="document.location='/download_docx'">Download DOCX</button>
                            <button onclick="document.location='/download_pdf'">Download PDF</button></br>
                            <button onclick="document.location='/download'">Download JSON</button>
                        </div>
                    </td>
                </tr>
            </table>

        </div>
        <footer id="discription">
            Version: 2.2</br>
            Uladzislau Sobal&copy;2021</br>
            <a href="https://github.com/N120F2/answer-collector">Github</a>
        </footer>
    </div>
</body>

</html>