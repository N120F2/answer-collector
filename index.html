<!DOCTYPE html>
<html>

<head>
    <title> Answer collector </title>
    <link rel="stylesheet" href="styles.css">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script>
        'use strict'
        async function getContributors() {
            let outResult = undefined;
            try {
                const response = await fetch('http://' + location.hostname + ':8080/contributors', {
                    method: 'GET',
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/json;charset=utf-8'
                    },
                });
                if (!response.ok) {
                    throw new Error("HTTP status " + response.status);
                }
                const result = await response.text();
                console.log('Contributors loaded');
                console.log(result);
                outResult = JSON.parse(result);
            } catch (e) {
                console.error(e);
            }
            return outResult;
        }
        document.addEventListener('DOMContentLoaded', function () {
            let stroragedLogin = localStorage.getItem('login');
            if (stroragedLogin !== null) document.getElementById("nameInput").value = stroragedLogin;
            getContributors()
                .then((contributors) => {
                    loadContrTable(contributors);
                })
                .catch(() => {
                    console.log("Contributors table loading failed");
                });
        });
        async function add(name, question, answer) {
            return new Promise(
                async (resolve, reject) => {
                    try {
                        const response = await fetch('http://' + location.hostname + ':8080/add', {
                            method: 'POST',
                            credentials: 'same-origin',
                            headers: {
                                'Content-Type': 'application/json;charset=utf-8'
                            },
                            body: JSON.stringify({
                                login: name,
                                question: question,
                                answer: answer
                            })
                        });
                        if (!response.ok) {
                            throw new Error("HTTP status " + response.status);
                        }
                        const result = await response.text();
                        resolve(result);
                    } catch (e) {
                        reject("error");
                    }
                });
        }
        async function uploadData() {
            console.log(document.getElementById("nameInput").selectedOptions[0].value);
            if (document.getElementById("nameInput").selectedOptions[0].value == 'deny') {
                document.getElementById("infoLabel").innerText = 'Pick your name!!!';
                document.getElementById('infoLabel').style.color = 'red';
                document.getElementById('infoLabel').style.display = 'block';
                document.getElementById('enterButton').style.display = 'none';
                setTimeout(() => {
                    document.getElementById('infoLabel').style.display = 'none';
                    document.getElementById('enterButton').style.display = 'block';
                }, 2000)
                return;
            }
            let name = document.getElementById("nameInput").selectedOptions[0].value;
            let question = document.getElementById('question').value;
            let answer = document.getElementById('answer').value;
            //document.getElementById("nameInput").value = '';
            document.getElementById('question').value = '';
            document.getElementById('answer').value = '';
            if (localStorage.getItem('login') != name) localStorage.setItem('login', name);
            let result = null;
            try {
                result = await add(name, question, answer);
                console.log(result);
            }
            catch (e) {
                console.log(e);
            }
            console.log(result);
            if (result == "good") {
                document.getElementById("infoLabel").innerText = 'Answer successfully added';
                document.getElementById('infoLabel').style.color = 'black';
            } else {
                document.getElementById("infoLabel").innerText = 'Some error! Try again.';
                document.getElementById('infoLabel').style.color = 'red';
            }
            document.getElementById('infoLabel').style.display = 'block';
            document.getElementById('enterButton').style.display = 'none';
            setTimeout(() => {
                document.getElementById('infoLabel').style.display = 'none';
                document.getElementById('enterButton').style.display = 'block';

            }, 2000)
        }
        function loadContrTable(contributorsObj) {
            const contributorsMap = new Map(Object.entries(contributorsObj));
            const contributorsMapSorted = new Map([...contributorsMap.entries()].sort((a, b) => b[1] - a[1]));
            var container = document.getElementById('contributorsContainer');
            var tbl = document.createElement('table');            
            tbl.style.display = 'inline-block';//inline-block
            tbl.setAttribute('id', 'contribTable');      
            var tbdy = document.createElement('tbody');
            for (let entry of contributorsMapSorted) {
                var tr = document.createElement('tr');
                for (var j = 0; j < 2; j++) {
                    var td = document.createElement('td');                    
                    if (j == 0){
                        td.innerText = entry[0];                      
                    } 
                    else {
                        td.innerText = entry[1];                        
                    }
                    tr.appendChild(td);
                }
                tbdy.appendChild(tr);
            }
            tbl.appendChild(tbdy);
            container.appendChild(tbl);
        }
    </script>


</head>

<body>
    <div id="page-container">

        <div id="content-wrap">
            <header id="headTitle">
                <h1 id='welcomeTitle'>Answer Collector</h1>
            </header>
            <table style="width: 100%;">
                <tr>
                    <td style="width: 300px;">
                        <div id='contributorsContainer'> </div>
                    </td>
                    <td >
                        <form id='enterForm' action='javascript: document.getElementById("enterButton").click();'>
                            <label id="inputLabel1" style="font-weight: bold;">Please enter your name:</label></br>
                            <!--<input type="text" id="nameInput" placeholder="Your name.."></br>-->
                            <select size="1" id="nameInput" required form="enterForm">
                                <option value='deny' selected disabled>Your name</option>
                                <option value="Piko">Piko</option>
                                <option value="Vlad">Vlad</option>
                                <option value="Anya">Anya</option>
                                <option value="Dima">Dima</option>
                            </select></br>

                            <label id="inputLabel2" style="font-weight: bold;">Please enter a question:</label></br>
                            <textarea id="question" placeholder="Past question here" rows="4" cols="50"></textarea></br>

                            <label id="inputLabel3" style="font-weight: bold;">Please enter a correct
                                answer:</label></br>
                            <textarea id="answer" placeholder="Past answer here" rows="4" cols="50"></textarea></br>

                            <label id="infoLabel" style="font-weight: bold; color:red; display:none"></label></br>

                            <button type="button" class="form_button" id="enterButton"
                                onclick='uploadData();'>Enter</button>
                        </form>
                    </td>
                </tr>                
            </table>           
            <a href="/download_docx" download="answers.json">Download DOCX answers </a></br>
            <a href="/download" download="answers.json">Download JSON answers </a>         
        </div>
        <footer id="discription">
            Version: 0.0</br>
            Uladzislau Sobal&copy;2021</br>
            <a href="https://github.com/N120F2/answer-collector">Github</a>
        </footer>
    </div>
</body>

</html>