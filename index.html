<!DOCTYPE html>
<html>

<head>
    <title> Answer collector </title>
    <link rel="stylesheet" href="styles.css">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script>
        'use strict'       
        document.addEventListener('DOMContentLoaded', function () { // Аналог $(document).ready(function(){
            document.getElementById("nameInput").value = localStorage.getItem('login');
        });
        async function add(name, question, answer) {
            return new Promise(
                async (resolve, reject) => {
                    try {
                        const response = await fetch('http://' + location.hostname + ':8080/add', {
                            method: 'POST',
                            credentials: 'same-origin',
                            headers: {
                                'Content-Type': 'application/json;charset=utf-8'
                            },
                            body: JSON.stringify({
                                login: name,
                                question: question,
                                answer: answer
                            })
                        });
                        if (!response.ok) {
                            throw new Error("HTTP status " + response.status);
                        }
                        const result = await response.text();
                        resolve(result);
                    } catch (e) {
                        reject("error");
                    }
                });
        }
        async function uploadData() {
            console.log(document.getElementById("nameInput").selectedOptions[0].value);
            if(document.getElementById("nameInput").selectedOptions[0].value == 'deny') {
                document.getElementById("infoLabel").innerText = 'Pick your name!!!';
                document.getElementById('infoLabel').style.color = 'red';
                document.getElementById('infoLabel').style.display = 'block';
                document.getElementById('enterButton').style.display = 'none';
                setTimeout(() => {
                document.getElementById('infoLabel').style.display = 'none'; 
                document.getElementById('enterButton').style.display = 'block';             
            }, 2000)
                return;
            }
            let name = document.getElementById("nameInput").selectedOptions[0].value;
            let question = document.getElementById('question').value;
            let answer = document.getElementById('answer').value;
            //document.getElementById("nameInput").value = '';
            document.getElementById('question').value = '';
            document.getElementById('answer').value = '';
            if(localStorage.getItem('login') != name) localStorage.setItem('login', name);
            let result = null;
            try {
                result = await add(name, question, answer);
                console.log(result);
            }
            catch (e) {
                console.log(e);
            }
            console.log(result);
            if (result == "good") {
                document.getElementById("infoLabel").innerText = 'Answer successfully added';
                document.getElementById('infoLabel').style.color = 'black';
            } else {
                document.getElementById("infoLabel").innerText = 'Some error! Try again.';
                document.getElementById('infoLabel').style.color = 'red';
            }
            document.getElementById('infoLabel').style.display = 'block';
            document.getElementById('enterButton').style.display = 'none';
            setTimeout(() => {
                document.getElementById('infoLabel').style.display = 'none';
                document.getElementById('enterButton').style.display = 'block';
                           
            }, 2000)
        }
    </script>


</head>

<body>
    <div id="page-container">

        <div id="content-wrap">
            <header id="headTitle">
                <h1 id='welcomeTitle'>Answer Collector</h1>
            </header>

            <form id='enterForm' action='javascript: document.getElementById("enterButton").click();'>
                <label id="inputLabel1" style="font-weight: bold;">Please enter your name:</label></br>
                <!--<input type="text" id="nameInput" placeholder="Your name.."></br>-->
                <select size="1" id="nameInput"  required form="enterForm" >
                    <option value='deny' selected  disabled>Your name</option>
                    <option value="Piko">Piko</option>
                    <option value="Vlad">Vlad</option>
                    <option value="Anya">Anya</option>
                    <option value="Dima">Dima</option>
                   </select></br>

                <label id="inputLabel2" style="font-weight: bold;">Please enter a question:</label></br>
                <textarea id="question" placeholder="Past question here" rows="4" cols="50"></textarea></br>

                <label id="inputLabel3" style="font-weight: bold;">Please enter a correct answer:</label></br>
                <textarea id="answer" placeholder="Past answer here" rows="4" cols="50"></textarea></br>

                <label id="infoLabel" style="font-weight: bold; color:red; display:none"></label></br>

                <button type="button" class="form_button" id="enterButton" onclick='uploadData();'>Enter</button>

            </form>
            <a href="/download" download="answers.txt" style='display: none;'>Download</a>
        </div>


        <footer id="discription">
            Version: 0.0</br>
            Uladzislau Sobal&copy;2021</br>
            <a href="https://github.com/N120F2/answer-collector">Github</a>
        </footer>
    </div>
</body>

</html>